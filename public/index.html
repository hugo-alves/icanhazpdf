<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ICanHazPDF - The Legal Way to Get That PDF</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            cream: '#FDF6E3',
            sage: '#E8F5E9',
            solar: {
              green: '#22C55E',
              lime: '#84CC16',
              amber: '#F59E0B',
              coral: '#FB7185',
              teal: '#14B8A6',
              sky: '#38BDF8',
            }
          },
          fontFamily: {
            mono: ['Space Mono', 'monospace'],
            display: ['Space Grotesk', 'sans-serif'],
          },
          boxShadow: {
            brutal: '4px 4px 0px 0px #000',
            'brutal-lg': '6px 6px 0px 0px #000',
            'brutal-sm': '2px 2px 0px 0px #000',
            'brutal-hover': '6px 6px 0px 0px #000',
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap');

    body {
      font-family: 'Space Grotesk', sans-serif;
      background: #FDF6E3;
      background-image:
        radial-gradient(circle at 20% 80%, rgba(34, 197, 94, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(245, 158, 11, 0.12) 0%, transparent 50%),
        radial-gradient(circle at 50% 50%, rgba(132, 204, 22, 0.08) 0%, transparent 70%);
    }

    .brutal-border {
      border: 3px solid #000;
    }

    .brutal-border-thick {
      border: 4px solid #000;
    }

    .hover-lift {
      transition: all 0.15s ease;
    }

    .hover-lift:hover {
      transform: translate(-2px, -2px);
      box-shadow: 6px 6px 0px 0px #000;
    }

    .hover-lift:active {
      transform: translate(0px, 0px);
      box-shadow: 2px 2px 0px 0px #000;
    }

    .plant-pattern {
      position: relative;
    }

    .plant-pattern::before {
      content: 'üåø';
      position: absolute;
      top: -12px;
      right: -12px;
      font-size: 24px;
      transform: rotate(15deg);
    }

    .marquee {
      animation: scroll 20s linear infinite;
    }

    @keyframes scroll {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }

    .loading-dots::after {
      content: '';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: ''; }
      40% { content: '.'; }
      60% { content: '..'; }
      80%, 100% { content: '...'; }
    }
  </style>
</head>
<body class="min-h-screen">
  <!-- Decorative corner plants -->
  <div class="fixed top-4 left-4 text-4xl opacity-60 pointer-events-none select-none">üå±</div>
  <div class="fixed top-4 right-4 text-4xl opacity-60 pointer-events-none select-none">üåø</div>
  <div class="fixed bottom-4 left-4 text-4xl opacity-60 pointer-events-none select-none">üçÉ</div>
  <div class="fixed bottom-4 right-4 text-4xl opacity-60 pointer-events-none select-none">üåª</div>

  <div class="container mx-auto px-4 py-8 md:py-12">
    <!-- Header -->
    <header class="text-center mb-10">
      <div class="inline-block brutal-border-thick bg-solar-green px-6 py-3 shadow-brutal-lg mb-6 rotate-[-1deg]">
        <h1 class="text-3xl md:text-5xl font-bold text-black tracking-tight font-display">
          ICANHAZPDF
        </h1>
      </div>
      <p class="text-lg md:text-xl font-mono text-gray-800 max-w-xl mx-auto">
        The legal way to get that PDF
        <span class="inline-block ml-1">‚ú®</span>
      </p>
    </header>

    <!-- Main Search Card -->
    <main class="max-w-2xl mx-auto">
      <div class="brutal-border-thick bg-white shadow-brutal-lg p-6 md:p-8 plant-pattern">
        <form id="searchForm" class="space-y-5">
          <div>
            <label for="title" class="block text-sm font-bold text-black uppercase tracking-wide mb-2 font-mono">
              Paper Title
            </label>
            <input
              type="text"
              id="title"
              name="title"
              placeholder="e.g., Attention Is All You Need"
              class="w-full px-4 py-3 brutal-border bg-cream font-mono text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-0 focus:bg-amber-50 transition-colors"
              required
            >
          </div>
          <button
            type="submit"
            id="searchBtn"
            class="w-full brutal-border bg-solar-amber text-black py-3 px-6 font-bold uppercase tracking-wider hover-lift shadow-brutal disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-brutal-sm font-mono"
          >
            <span id="btnText">Search Papers</span>
          </button>
        </form>

        <!-- Search History -->
        <div id="searchHistory" class="mt-4 hidden">
          <div class="flex items-center justify-between mb-2">
            <span class="text-xs font-mono text-gray-500 uppercase">Recent Searches</span>
            <button id="clearHistory" class="text-xs font-mono text-gray-400 hover:text-gray-600">Clear</button>
          </div>
          <div id="historyList" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- Live Progress -->
        <div id="progress" class="mt-6 hidden">
          <div class="brutal-border bg-cream p-4">
            <div class="flex items-center gap-2 mb-3">
              <span class="text-lg animate-pulse">üîç</span>
              <span class="font-mono text-sm font-bold uppercase">Searching Sources</span>
            </div>
            <div id="progressList" class="space-y-2 font-mono text-sm"></div>
          </div>
        </div>

        <!-- Results -->
        <div id="results" class="mt-8 hidden">
          <div class="border-t-4 border-black pt-6">
            <div class="flex items-center gap-2 mb-4">
              <span class="bg-black text-white px-2 py-1 text-xs font-mono uppercase">Result</span>
            </div>
            <div id="resultContent"></div>
          </div>
        </div>

        <!-- Error -->
        <div id="error" class="mt-6 hidden">
          <div class="brutal-border bg-solar-coral/20 p-4">
            <div class="flex items-start gap-2">
              <span class="text-xl">‚ö†Ô∏è</span>
              <p class="text-black font-mono text-sm" id="errorText"></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Sources Info -->
      <div class="mt-8 brutal-border bg-sage shadow-brutal p-5">
        <div class="flex items-center gap-2 mb-4">
          <span class="text-xl">üìö</span>
          <h3 class="text-sm font-bold text-black uppercase tracking-wider font-mono">Data Sources</h3>
        </div>
        <div class="flex flex-wrap gap-2">
          <span class="brutal-border px-3 py-1.5 bg-solar-green text-black text-xs font-bold uppercase font-mono hover-lift shadow-brutal-sm cursor-default">arXiv</span>
          <span class="brutal-border px-3 py-1.5 bg-solar-sky text-black text-xs font-bold uppercase font-mono hover-lift shadow-brutal-sm cursor-default">Semantic Scholar</span>
          <span class="brutal-border px-3 py-1.5 bg-solar-lime text-black text-xs font-bold uppercase font-mono hover-lift shadow-brutal-sm cursor-default">OpenAlex</span>
          <span class="brutal-border px-3 py-1.5 bg-solar-amber text-black text-xs font-bold uppercase font-mono hover-lift shadow-brutal-sm cursor-default">PubMed</span>
          <span class="brutal-border px-3 py-1.5 bg-solar-coral text-black text-xs font-bold uppercase font-mono hover-lift shadow-brutal-sm cursor-default">CORE</span>
          <span class="brutal-border px-3 py-1.5 bg-solar-teal text-black text-xs font-bold uppercase font-mono hover-lift shadow-brutal-sm cursor-default">Crossref</span>
          <span class="brutal-border px-3 py-1.5 bg-white text-black text-xs font-bold uppercase font-mono hover-lift shadow-brutal-sm cursor-default">Web Search</span>
          <span class="brutal-border px-3 py-1.5 bg-cream text-black text-xs font-bold uppercase font-mono hover-lift shadow-brutal-sm cursor-default">Unpaywall</span>
        </div>
      </div>

      <!-- Footer -->
      <footer class="mt-10 text-center">
        <p class="font-mono text-sm text-gray-600">
          Open access research for everyone üåç
        </p>
        <p class="font-mono text-xs text-gray-400 mt-2">
          <a href="https://github.com/hugo-alves/icanhazpdf" target="_blank" class="hover:text-gray-600">GitHub</a>
        </p>
      </footer>
    </main>
  </div>

  <script>
    const form = document.getElementById('searchForm');
    const progress = document.getElementById('progress');
    const progressList = document.getElementById('progressList');
    const results = document.getElementById('results');
    const resultContent = document.getElementById('resultContent');
    const error = document.getElementById('error');
    const errorText = document.getElementById('errorText');
    const searchBtn = document.getElementById('searchBtn');
    const btnText = document.getElementById('btnText');
    const searchHistory = document.getElementById('searchHistory');
    const historyList = document.getElementById('historyList');
    const clearHistoryBtn = document.getElementById('clearHistory');
    const titleInput = document.getElementById('title');

    // Search History Management
    const MAX_HISTORY = 10;
    const HISTORY_KEY = 'icanhazpdf_history';

    function getHistory() {
      try {
        return JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
      } catch {
        return [];
      }
    }

    function saveToHistory(title) {
      const history = getHistory().filter(h => h.toLowerCase() !== title.toLowerCase());
      history.unshift(title);
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history.slice(0, MAX_HISTORY)));
      renderHistory();
    }

    function clearHistory() {
      localStorage.removeItem(HISTORY_KEY);
      renderHistory();
    }

    function renderHistory() {
      const history = getHistory();
      if (history.length === 0) {
        searchHistory.classList.add('hidden');
        return;
      }

      searchHistory.classList.remove('hidden');
      historyList.innerHTML = history.map(title => `
        <button
          type="button"
          class="history-item brutal-border px-3 py-1 bg-white text-black text-xs font-mono hover-lift shadow-brutal-sm truncate max-w-[200px]"
          title="${title}"
        >${title.length > 30 ? title.substring(0, 30) + '...' : title}</button>
      `).join('');
    }

    // History click handler
    historyList.addEventListener('click', (e) => {
      if (e.target.classList.contains('history-item')) {
        titleInput.value = e.target.title;
        form.dispatchEvent(new Event('submit'));
      }
    });

    clearHistoryBtn.addEventListener('click', clearHistory);

    // Initial render
    renderHistory();

    // Source status icons
    const STATUS_ICONS = {
      trying: '‚è≥',
      found: '‚úÖ',
      no_pdf: '‚ùå',
      error: '‚ö†Ô∏è',
      selected: 'üéØ'
    };

    // Source colors for badges
    const SOURCE_COLORS = {
      'arXiv': 'bg-solar-green',
      'Semantic Scholar': 'bg-solar-sky',
      'OpenAlex': 'bg-solar-lime',
      'PubMed Central': 'bg-solar-amber',
      'CORE': 'bg-solar-coral',
      'Crossref': 'bg-solar-teal',
      'Web Search': 'bg-white',
      'Unpaywall': 'bg-cream'
    };

    function updateSourceStatus(source, status, extra = '') {
      const id = `source-${source.replace(/\s+/g, '-')}`;
      let el = document.getElementById(id);

      if (!el) {
        el = document.createElement('div');
        el.id = id;
        el.className = 'flex items-center gap-2 py-1';
        progressList.appendChild(el);
      }

      const color = SOURCE_COLORS[source] || 'bg-gray-100';
      const icon = STATUS_ICONS[status] || '‚è≥';
      const statusText = status === 'found' ? 'PDF found!' :
                        status === 'no_pdf' ? 'No PDF' :
                        status === 'error' ? 'Error' :
                        status === 'trying' ? 'Searching...' : status;

      el.innerHTML = `
        <span>${icon}</span>
        <span class="brutal-border px-2 py-0.5 ${color} text-black text-xs font-bold uppercase">${source}</span>
        <span class="text-gray-600">${statusText}</span>
        ${extra ? `<span class="text-gray-400 text-xs">${extra}</span>` : ''}
      `;
    }

    // Show early result while other sources continue searching
    function showEarlyResult(source, pdfUrl) {
      results.classList.remove('hidden');
      const color = SOURCE_COLORS[source] || 'bg-gray-100';
      resultContent.innerHTML = `
        <div class="brutal-border bg-solar-green/20 p-4 space-y-4">
          <div class="flex items-center flex-wrap gap-2">
            <span class="text-2xl">üåø</span>
            <span class="font-bold text-black uppercase font-mono">Found!</span>
            <span class="brutal-border px-2 py-0.5 ${color} text-black text-xs font-bold uppercase font-mono">${source}</span>
            <span class="text-xs text-gray-500 animate-pulse">(checking other sources...)</span>
          </div>
          <div class="flex flex-wrap gap-2">
            <a
              href="${pdfUrl}"
              target="_blank"
              id="earlyPdfLink"
              class="inline-flex items-center gap-2 brutal-border bg-solar-green text-black px-4 py-2 font-bold uppercase font-mono text-sm hover-lift shadow-brutal-sm"
            >
              <span>Download PDF</span>
              <span>‚Üì</span>
            </a>
          </div>
        </div>
      `;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const title = document.getElementById('title').value.trim();
      if (!title) return;

      // Save to history
      saveToHistory(title);

      // Reset UI
      progress.classList.remove('hidden');
      progressList.innerHTML = '';
      results.classList.add('hidden');
      error.classList.add('hidden');
      searchBtn.disabled = true;
      btnText.innerHTML = '<span class="loading-dots">Searching</span>';

      try {
        // Use SSE for real-time progress
        const eventSource = new EventSource(`/api/fetch-stream?title=${encodeURIComponent(title)}`);

        eventSource.addEventListener('start', (e) => {
          const data = JSON.parse(e.data);
          progressList.innerHTML = `<div class="text-gray-500">Checking ${data.sources} sources...</div>`;
        });

        eventSource.addEventListener('cache_hit', (e) => {
          progressList.innerHTML = '<div class="flex items-center gap-2">‚ö° <span class="text-solar-green font-bold">Cache hit!</span></div>';
        });

        eventSource.addEventListener('trying', (e) => {
          const data = JSON.parse(e.data);
          updateSourceStatus(data.source, 'trying');
        });

        // Track first found result for immediate display
        let firstFoundResult = null;

        eventSource.addEventListener('found', (e) => {
          const data = JSON.parse(e.data);
          updateSourceStatus(data.source, 'found');

          // Show immediate result on first PDF found
          if (!firstFoundResult) {
            firstFoundResult = data;
            showEarlyResult(data.source, data.pdf_url);
          }
        });

        eventSource.addEventListener('no_pdf', (e) => {
          const data = JSON.parse(e.data);
          updateSourceStatus(data.source, 'no_pdf', data.doi ? `DOI: ${data.doi}` : '');
        });

        eventSource.addEventListener('error', (e) => {
          try {
            const data = JSON.parse(e.data);
            if (data.source) {
              updateSourceStatus(data.source, 'error');
            }
          } catch {}
        });

        eventSource.addEventListener('selected', (e) => {
          const data = JSON.parse(e.data);
          updateSourceStatus(data.source, 'selected', `(${data.count} sources had PDFs)`);
        });

        eventSource.addEventListener('complete', (e) => {
          const data = JSON.parse(e.data);
          eventSource.close();

          progress.classList.add('hidden');
          searchBtn.disabled = false;
          btnText.innerHTML = 'Search Papers';

          if (data.success) {
            results.classList.remove('hidden');
            const doi = data.metadata?.doi;
            const alternatives = data.alternatives || [];

            // Build alternatives HTML if there are any
            const alternativesHtml = alternatives.length > 0 ? `
              <details class="mt-3">
                <summary class="cursor-pointer text-xs font-mono text-gray-500 hover:text-gray-700">
                  + ${alternatives.length} alternative source${alternatives.length > 1 ? 's' : ''}
                </summary>
                <div class="mt-2 flex flex-wrap gap-2">
                  ${alternatives.map(alt => `
                    <a
                      href="${alt.pdf_url}"
                      target="_blank"
                      class="inline-flex items-center gap-1 brutal-border bg-white text-black px-3 py-1.5 font-mono text-xs hover-lift shadow-brutal-sm"
                    >
                      <span>${alt.source}</span>
                      <span>‚Üó</span>
                    </a>
                  `).join('')}
                </div>
              </details>
            ` : '';

            resultContent.innerHTML = `
              <div class="brutal-border bg-solar-green/20 p-4 space-y-4">
                <div class="flex items-center flex-wrap gap-2">
                  <span class="text-2xl">üåø</span>
                  <span class="font-bold text-black uppercase font-mono">Found!</span>
                  <span class="brutal-border px-2 py-0.5 bg-solar-lime text-black text-xs font-bold uppercase font-mono">${data.source}</span>
                  ${data.cached ? '<span class="text-xs text-gray-500">(cached)</span>' : ''}
                </div>
                ${data.metadata?.title ? `<p class="font-bold text-black text-lg">${data.metadata.title}</p>` : ''}
                ${data.metadata?.authors ? `<p class="text-gray-700 font-mono text-sm">${data.metadata.authors}</p>` : ''}
                <div class="flex flex-wrap gap-2">
                  <a
                    href="${data.pdf_url}"
                    target="_blank"
                    class="inline-flex items-center gap-2 brutal-border bg-solar-green text-black px-4 py-2 font-bold uppercase font-mono text-sm hover-lift shadow-brutal-sm"
                  >
                    <span>Download PDF</span>
                    <span>‚Üì</span>
                  </a>
                  ${doi ? `
                    <button
                      type="button"
                      id="copyBibtex"
                      data-doi="${doi}"
                      class="inline-flex items-center gap-2 brutal-border bg-solar-sky text-black px-4 py-2 font-bold uppercase font-mono text-sm hover-lift shadow-brutal-sm"
                    >
                      <span id="bibtexBtnText">Copy BibTeX</span>
                      <span>üìã</span>
                    </button>
                  ` : ''}
                </div>
                ${alternativesHtml}
              </div>
            `;

            // BibTeX copy handler
            const bibtexBtn = document.getElementById('copyBibtex');
            if (bibtexBtn) {
              bibtexBtn.addEventListener('click', async () => {
                const btnTextEl = document.getElementById('bibtexBtnText');
                const doi = bibtexBtn.dataset.doi;
                btnTextEl.textContent = 'Loading...';

                try {
                  const res = await fetch(`/api/bibtex?doi=${encodeURIComponent(doi)}`);
                  const result = await res.json();

                  if (result.success) {
                    await navigator.clipboard.writeText(result.bibtex);
                    btnTextEl.textContent = 'Copied!';
                    setTimeout(() => { btnTextEl.textContent = 'Copy BibTeX'; }, 2000);
                  } else {
                    btnTextEl.textContent = 'Error';
                    setTimeout(() => { btnTextEl.textContent = 'Copy BibTeX'; }, 2000);
                  }
                } catch (err) {
                  btnTextEl.textContent = 'Error';
                  setTimeout(() => { btnTextEl.textContent = 'Copy BibTeX'; }, 2000);
                }
              });
            }
          } else {
            error.classList.remove('hidden');
            errorText.textContent = data.error || 'Paper not found in any source. Try a different title!';
            if (data.doi) {
              errorText.textContent += ` DOI found: ${data.doi}`;
            }
          }
        });

        // Fallback error handler
        eventSource.onerror = () => {
          eventSource.close();
          progress.classList.add('hidden');
          error.classList.remove('hidden');
          errorText.textContent = 'Connection error. Please try again.';
          searchBtn.disabled = false;
          btnText.innerHTML = 'Search Papers';
        };

      } catch (err) {
        progress.classList.add('hidden');
        error.classList.remove('hidden');
        errorText.textContent = 'Connection error: ' + err.message;
        searchBtn.disabled = false;
        btnText.innerHTML = 'Search Papers';
      }
    });
  </script>
</body>
</html>
